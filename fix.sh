#!/bin/bash

echo "=== –ë—ã—Å—Ç—Ä–æ–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º CeresWEB ==="

# –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤—Å–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã
echo "üõë –û—Å—Ç–∞–Ω–æ–≤–∫–∞ –≤—Å–µ—Ö –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤..."
docker compose down

# –£–¥–∞–ª—è–µ–º –≤–æ–∑–º–æ–∂–Ω–æ –ø–æ–≤—Ä–µ–∂–¥–µ–Ω–Ω—ã–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
echo "üóëÔ∏è  –û—á–∏—Å—Ç–∫–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–π..."
rm -f ./nginx/conf.d/app.conf

# –ö–æ–ø–∏—Ä—É–µ–º HTTP-only –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é
echo "üìã –£—Å—Ç–∞–Ω–æ–≤–∫–∞ HTTP-only –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏..."
cp ./nginx/conf.d/app-http-only.conf.backup ./nginx/conf.d/app.conf

# –ü–µ—Ä–µ—Å–æ–∑–¥–∞–µ–º —Å–µ—Ç—å (–Ω–∞ —Å–ª—É—á–∞–π –ø—Ä–æ–±–ª–µ–º —Å DNS)
echo "üåê –ü–µ—Ä–µ—Å–æ–∑–¥–∞–Ω–∏–µ Docker —Å–µ—Ç–∏..."
docker network prune -f

echo "üèóÔ∏è  –ó–∞–ø—É—Å–∫ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è..."
docker compose up -d

echo "‚è≥ –û–∂–∏–¥–∞–Ω–∏–µ –∑–∞–ø—É—Å–∫–∞..."
sleep 20

echo "üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞:"
docker compose ps

echo "üìù –ü—Ä–æ–≤–µ—Ä–∫–∞ –ª–æ–≥–æ–≤ nginx:"
docker compose logs --tail=10 nginx

echo "üåê –¢–µ—Å—Ç –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏:"
if curl -I -m 10 "http://ceres-tech.ru" 2>/dev/null | head -1; then
    echo "‚úÖ –°–∞–π—Ç –¥–æ—Å—Ç—É–ø–µ–Ω!"
    echo "üåê –ü—Ä–æ–≤–µ—Ä—å—Ç–µ: http://ceres-tech.ru"
else
    echo "‚ùå –°–∞–π—Ç –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏:"
    echo "docker compose logs nginx"
    echo "docker compose logs nextjs"
fi

echo ""
echo "üí° –î–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è SSL –ø–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∑–∞–ø—É—Å—Ç–∏—Ç–µ:"
echo "./deploy.sh"
