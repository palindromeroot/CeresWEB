#!/bin/bash

echo "=== –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –Ω–∞ HTTPS —Å –ø–µ—Ä–µ–∞–¥—Ä–µ—Å–∞—Ü–∏–µ–π ==="

# –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ SSL —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–∞
if [ ! -f "./certbot/conf/live/ceres-tech.ru/fullchain.pem" ]; then
    echo "‚ùå SSL —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω!"
    echo "üí° –°–Ω–∞—á–∞–ª–∞ –ø–æ–ª—É—á–∏—Ç–µ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç –∫–æ–º–∞–Ω–¥–æ–π: ./deploy.sh"
    exit 1
fi

echo "‚úÖ SSL —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç –Ω–∞–π–¥–µ–Ω"

# –ü–µ—Ä–µ–∫–ª—é—á–∞–µ–º—Å—è –Ω–∞ HTTPS –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é —Å –ø–µ—Ä–µ–∞–¥—Ä–µ—Å–∞—Ü–∏–µ–π
echo "üîÑ –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –Ω–∞ HTTPS –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é —Å –ø–µ—Ä–µ–∞–¥—Ä–µ—Å–∞—Ü–∏–µ–π..."
cp ./nginx/conf.d/app-https-redirect.conf ./nginx/conf.d/app.conf

echo "üîÑ –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ nginx..."
docker compose restart nginx

echo "‚è≥ –û–∂–∏–¥–∞–Ω–∏–µ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞..."
sleep 5

echo "üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ nginx..."
if docker compose ps nginx | grep -q "Up"; then
    echo "‚úÖ Nginx –∑–∞–ø—É—â–µ–Ω —É—Å–ø–µ—à–Ω–æ"
    
    echo "üåê –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–µ—Ä–µ–∞–¥—Ä–µ—Å–∞—Ü–∏–∏..."
    echo "HTTP –∑–∞–ø—Ä–æ—Å –¥–æ–ª–∂–µ–Ω –ø–µ—Ä–µ–∞–¥—Ä–µ—Å–æ–≤–∞—Ç—å –Ω–∞ HTTPS:"
    
    if curl -I -m 10 "http://ceres-tech.ru" 2>/dev/null | grep -q "301\|302"; then
        echo "‚úÖ HTTP –ø–µ—Ä–µ–∞–¥—Ä–µ—Å–∞—Ü–∏—è —Ä–∞–±–æ—Ç–∞–µ—Ç!"
    else
        echo "‚ö†Ô∏è  –ü–µ—Ä–µ–∞–¥—Ä–µ—Å–∞—Ü–∏—è –º–æ–∂–µ—Ç –Ω–µ —Ä–∞–±–æ—Ç–∞—Ç—å"
    fi
    
    echo ""
    echo "üéâ –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ!"
    echo "üåê –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å–∞–π—Ç:"
    echo "   HTTP:  http://ceres-tech.ru (–¥–æ–ª–∂–µ–Ω –ø–µ—Ä–µ–∞–¥—Ä–µ—Å–æ–≤–∞—Ç—å)"
    echo "   HTTPS: https://ceres-tech.ru"
    
else
    echo "‚ùå –û—à–∏–±–∫–∞ –∑–∞–ø—É—Å–∫–∞ nginx!"
    echo "üìù –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏:"
    docker compose logs nginx
fi
